<!DOCTYPE html>
<meta charset="utf-8">

<style type="text/css">
	/* 13. Basic Styling with CSS */

	/* Style the lines by removing the fill and applying a stroke */
	.line {
		fill: none;
		stroke: #ffab00;
		stroke-width: 3;
	}

	.overlay {
		fill: none;
		pointer-events: all;
	}

	/* Style the dots by assigning a fill and stroke */
	.dot {
		fill: #ffab00;
		stroke: #fff;
	}

	.focus circle {
		fill: none;
		stroke: steelblue;
	}
</style>

<body>
	<button onclick="riskSelector('high')">highRisk</button>
	<button onclick="riskSelector('medium')">mediumRisk</button>
	<button onclick="riskSelector('low')">lowRisk</button>
	<div id="chart"></div>
</body>

<!-- Load in the d3 library -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="CalculationEngine.js"></script>

<script>

	let generator = new Calculation.CalculationEngine(3000, 100, 10);
	let result = generator.mediumRiskResults();
	let time = generator.timescaleInYears * 12

	function riskSelector(level) {
		switch (level) {
			case 'high':
				result = generator.highRiskResults();
				updateData();
				break;
			case 'low':
				result = generator.lowRiskResults();
				updateData();
				break;
			case 'medium':
				result = generator.mediumRiskResults();
				updateData();
				break;
			default:
				result = generator.mediumRiskResults();
		}
	}

	console.log(result)

	const data = Object.entries(result).map(([name, values]) => {
		values = values.map((amount, i) => {
			return {
				time: new Date().getFullYear() + i,
				amount: Math.round(amount)
			}
		})
		return { name, values }
	})

	const width = 800;
	const height = 500;
	const margin = 150;
	const duration = 250;

	const lineOpacity = "0.25";
	const lineOpacityHover = "0.85";
	const otherLinesOpacityHover = "0.1";
	const lineStroke = "1.5px";
	const lineStrokeHover = "2.5px";

	const circleOpacity = '0.85';
	const circleOpacityOnLineHover = "0.25"
	const circleRadius = 3;
	const circleRadiusHover = 6;

	/* Scale */
	const xScale = d3.scaleTime()
		.domain(d3.extent(data[0].values, d => d.time))
		.range([0, width - margin]);

	const yScale = d3.scaleLinear()
		.domain([0, d3.max(data[0].values, d => d.amount * 1.5)])
		.range([height - margin, 0]);

	const color = d3.scaleOrdinal(d3.schemeCategory10);

	/* Add SVG */
	const svg = d3.select("#chart").append("svg")
		.attr("width", (width + margin) + "px")
		.attr("height", (height + margin) + "px")
		.append('g')
		.attr("transform", `translate(${margin}, ${margin})`);


	/* Add line into SVG */
	const line = d3.line()
		.x(d => xScale(d.time))
		.y(d => yScale(d.amount));

	const lines = svg.append('g')
		.attr('class', 'lines');

	const lineGroup = lines.selectAll('.line-group')
		.data(data)
	const circleGroup = lines.selectAll("circle-group")
		.data(data)
	const dotGroup = circleGroup.selectAll("circle")
		.data(d => d.values)

	function updateData() {
		lineGroup.exit().remove(),
		circleGroup.exit().remove(),
		dotGroup.exit().remove()
		return {
			lineGroup: lineGroup.enter().append('g'),
			circleGroup: circleGroup.enter().append("g"),
			dotGroup: dotGroup.enter().append("g")
		}
	}

	updateData().lineGroup
		.attr('class', 'line-group')
		.on("mouseover", function (d, i) {
			svg.append("text")
				.attr("class", "title-text")
				.style("fill", color(i))
				.text(d.name)
				.attr("text-anchor", "middle")
				.attr("x", (width - margin) / 2)
				.attr("y", 5);
		})
		.on("mouseout", function (d) {
			svg.select(".title-text").remove();
		})
		.append('path')
		.attr('class', 'line')
		.attr('d', d => line(d.values))
		.style('stroke', (d, i) => color(i))
		.style('opacity', lineOpacity)
		.on("mouseover", function (d) {
			d3.selectAll('.line')
				.style('opacity', otherLinesOpacityHover);
			d3.selectAll('.circle')
				.style('opacity', circleOpacityOnLineHover);
			d3.select(this)
				.style('opacity', lineOpacityHover)
				.style("stroke-width", lineStrokeHover)
				.style("cursor", "pointer");
		})
		.on("mouseout", function (d) {
			d3.selectAll(".line")
				.style('opacity', lineOpacity);
			d3.selectAll('.circle')
				.style('opacity', circleOpacity);
			d3.select(this)
				.style("stroke-width", lineStroke)
				.style("cursor", "none");
		});


	/* Add circles in the line */
	updateData().circleGroup
		.style("fill", (d, i) => color(i))
		.selectAll("circle")
		.data(d => d.values).enter()
		.append("g")
		.attr("class", "circle")
		.on("mouseover", function (d) {
			d3.select(this)
				.style("cursor", "pointer")
				.append("text")
				.attr("class", "text")
				.text(`${d.amount}`)
				.attr("x", d => xScale(d.time) + 25)
				.attr("y", d => yScale(d.amount) - 10);
		})
		.on("mouseout", function (d) {
			d3.select(this)
				.style("cursor", "none")
				.transition()
				.duration(duration)
				.selectAll(".text").remove();
		})
		.append("circle")
		.attr("cx", d => xScale(d.time))
		.attr("cy", d => yScale(d.amount))
		.attr("r", circleRadius)
		.style('opacity', circleOpacity)
		.on("mouseover", function (d) {
			d3.select(this)
				.transition()
				.duration(duration)
				.attr("r", circleRadiusHover);
		})
		.on("mouseout", function (d) {
			d3.select(this)
				.transition()
				.duration(duration)
				.attr("r", circleRadius);
		});


	/* Add Axis into SVG */
	let xAxis = d3.axisBottom(xScale).ticks(5);
	let yAxis = d3.axisLeft(yScale).ticks(5);

	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", `translate(0, ${height - margin})`)
		.call(xAxis);

	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.append('text')
		.attr("y", 15)
		.attr("transform", "rotate(-90)")
		.attr("fill", "#000")
		.text("Total values");


	updateData();
</script>



<html>